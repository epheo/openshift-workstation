<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 9.1.0" />
<title>OpenShift Workstation with Single GPU passthrough</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>OpenShift Workstation with Single GPU passthrough</h1>
<span id="author">Thibaut Lapierre</span><br />
<span id="email"><code>&lt;<a href="mailto:tla@redhat.com">tla@redhat.com</a>&gt;</code></span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>This arcticle discribes a way to run OpenShift as a workstation with GPU PCI
passthrough and using Container Native Virtualization (CNV) in order to provide
a virtualized Desktop experience running on a single OpenShift node.</p></div>
<div class="paragraph"><p>This is used to run Microsoft FlightSimulator in a Windows VM with performances
close from a Bare metal Windows installation.</p></div>
<div class="paragraph"><p>In the future, a few improvements will be worked on:
* Reducing the Control Plane footprint by relaying on microshift instead.
* Using GPU from containers instead of virtual machines for Linux Desktop.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_hardware_description">Hardware description</h2>
<div class="sectionbody">
<div class="paragraph"><p>The workstation in use for this demo is a compact, mini-ITX workstation with the
following hardware:
* AMD Ryzen 9 3950X 16-Core 32-Threads
* 64GB DDR4
* Nvidia RTX 3080
* 2x NVMe Disks
* 1x SSD Disk
* Single NIC 1GB</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_backup_of_existing_system_partitions">Backup of existing system partitions.</h2>
<div class="sectionbody">
<div class="paragraph"><p>In order to avoid boot order conflicts, the OpenShift assisted installer will
format the 512 first bytes of any disks that contains a bootable partition.</p></div>
<div class="paragraph"><p>Ref: <a href="https://github.com/openshift/assisted-service/blob/d37ac44051be76e95676f33b8361c04eae290357/internal/host/hostcommands/install_cmd.go#L232">https://github.com/openshift/assisted-service/blob/d37ac44051be76e95676f33b8361c04eae290357/internal/host/hostcommands/install_cmd.go#L232</a></p></div>
<div class="paragraph"><p>Therefore, in order to avoid loosing any existing system it is important to
backup and remove any existing EFI/BIOS and boot partitions from already
existing disks.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_installing_openshift_sno">Installing OpenShift SNO</h2>
<div class="sectionbody">
<div class="paragraph"><p>Ref: <a href="https://docs.openshift.com/container-platform/4.10/installing/installing_sno/install-sno-installing-sno.html">https://docs.openshift.com/container-platform/4.10/installing/installing_sno/install-sno-installing-sno.html</a></p></div>
<div class="paragraph"><p>Once any existing file system is backed up and there is no more bootable
partitions we can proceed with the OpenShift Single Node install.</p></div>
<div class="paragraph"><p>It is important to note that CoreOS, the underlying operating system requires an
entire disk for installation.</p></div>
<div class="paragraph"><p>Here, we will keep the two NVMe disks for the persistant volumes as LVM Physical
volumes belonging to a same Volume Group and we will use the SSD disk for the
OpenShift operating system.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#!/bin/bash

OCP_VERSION=latest-4.10

curl -k https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz &gt; oc.tar.gz
tar zxf oc.tar.gz
chmod +x oc &amp;&amp; mv oc ~/.local/bin/

curl -k https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$OCP_VERSION/openshift-install-linux.tar.gz &gt; openshift-install-linux.tar.gz
tar zxvf openshift-install-linux.tar.gz
chmod +x openshift-install &amp;&amp; mv openshift-install ~/.local/bin/

curl $(openshift-install coreos print-stream-json | grep location | grep x86_64 | grep iso | cut -d\" -f4) &gt; rhcos-live.x86_64.iso</code></pre>
</div></div>
<div class="listingblock">
<div class="title">install-config.yaml</div>
<div class="content">
<pre><code>apiVersion: v1
baseDomain: epheo.eu
compute:
- name: worker
  replicas: 0
controlPlane:
  name: master
  replicas: 1
metadata:
  name: da2
networking:
  networkType: OVNKubernetes
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  serviceNetwork:
  - 172.30.0.0/16
platform:
  none: {}
bootstrapInPlace:
  installationDisk: /dev/sda
pullSecret: '{"auths":{"cloud.openshift.com":{"auth":"XXXXXXXX"}}}'
sshKey: |
  ssh-rsa AAAAB3XXXXXXXXXXXXXXXXXXXXXXXXX</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Generate OpenShift Container Platform assets:</div>
<div class="content">
<pre><code>mkdir ocp &amp;&amp; cp install-config.yaml ocp
openshift-install --dir=ocp create single-node-ignition-config</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Embed the ignition data into the RHCOS ISO:</div>
<div class="content">
<pre><code>alias coreos-installer='podman run --privileged --rm \
      -v /dev:/dev -v /run/udev:/run/udev -v $PWD:/data \
      -w /data quay.io/coreos/coreos-installer:release'
cp ocp/bootstrap-in-place-for-live-iso.ign iso.ign
coreos-installer iso ignition embed -fi iso.ign rhcos-live.x86_64.iso
dd if=discovery_image_sno.iso of=/dev/usbkey status=progress</code></pre>
</div></div>
<div class="paragraph"><p>Once the ISO is copied to the USB drive, you can use the USB drive to boot your
workstation node and install OpenShift Container Platform.</p></div>
<div class="sect2">
<h3 id="_install_cnv_operator">Install CNV Operator</h3>
<div class="paragraph"><p>Activate Intel VT or AMD-V hardware virtualization extensions in BIOS.</p></div>
<div class="paragraph"><p>ref: <a href="https://docs.openshift.com/container-platform/4.10/virt/install/installing-virt-cli.html">https://docs.openshift.com/container-platform/4.10/virt/install/installing-virt-cli.html</a></p></div>
<div class="listingblock">
<div class="title">cnv-resources.yaml</div>
<div class="content">
<pre><code>apiVersion: v1
kind: Namespace
metadata:
  name: openshift-cnv
---
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: kubevirt-hyperconverged-group
  namespace: openshift-cnv
spec:
  targetNamespaces:
    - openshift-cnv
---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: hco-operatorhub
  namespace: openshift-cnv
spec:
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  name: kubevirt-hyperconverged
  startingCSV: kubevirt-hyperconverged-operator.v4.10.0
  channel: "stable"</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>oc apply -f cnv-resources.yaml</code></pre>
</div></div>
<div class="paragraph"><p>Installing the Virtctl client on your desktop.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>subscription-manager repos --enable cnv-4.10-for-rhel-8-x86_64-rpms
dnf install kubevirt-virtctl</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_remove_local_storage_operator_if_installed">Remove Local Storage operator (if installed)</h3>
<div class="paragraph"><p>As we do not need to manage LVM volumes automatically we would like to avoid
automatically formating Logical Volumes once they are deleted from OpenShift.</p></div>
<div class="paragraph"><p>While this could lead to data leak in a multi-tenant environment, removing the
Local Storage Operator also avoid loosing your Virtual Machine partitions once
you delete it.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_openshift_for_single_gpu_passthrough">Configure OpenShift for single GPU passthrough</h2>
<div class="sectionbody">
<div class="paragraph"><p>As our GPU is the only one attached to the node a few additional steps are
required.</p></div>
<div class="paragraph"><p>We will use MachineConfig to configure our node accordingly.</p></div>
<div class="paragraph"><p>All MachineConfig are applied on the master machineset because we have a single
node OpenShift. With a multi nodes cluster those would be applied to worker
instead.</p></div>
<div class="paragraph"><p>Ref: <a href="https://github.com/openshift/machine-config-operator/blob/master/docs/SingleNodeOpenShift.md">https://github.com/openshift/machine-config-operator/blob/master/docs/SingleNodeOpenShift.md</a></p></div>
<div class="sect2">
<h3 id="_adding_iommu_and_vga_off_kernel_arguments">Adding IOMMU and VGA off Kernel arguments</h3>
<div class="paragraph"><p>To prevent Host system to bind console to GPU</p></div>
<div class="paragraph"><p><a href="https://www.reddit.com/r/VFIO/comments/cktnhv/bar_0_cant_reserve/">https://www.reddit.com/r/VFIO/comments/cktnhv/bar_0_cant_reserve/</a>
<a href="https://www.reddit.com/r/VFIO/comments/mx5td8/bar_3_cant_reserve_mem_0xc00000000xc1ffffff_64bit/">https://www.reddit.com/r/VFIO/comments/mx5td8/bar_3_cant_reserve_mem_0xc00000000xc1ffffff_64bit/</a></p></div>
<div class="paragraph"><p>Ref: <a href="https://docs.kernel.org/fb/fbcon.html">https://docs.kernel.org/fb/fbcon.html</a></p></div>
<div class="listingblock">
<div class="title">100-sno-kernelargs.yaml</div>
<div class="content">
<pre><code>apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 100-sno-kernelargs
spec:
  config:
    ignition:
      version: 3.2.0
  kernelArguments:
      - amd_iommu=on
      - vga=off
      - rdblaclist=nouveau
      - 'video=efifb:off'</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">If you&#8217;re using an Intel CPU you&#8217;ll have to set intel_iommu=on instead.</td>
</tr></table>
</div>
<div class="paragraph"><p>We deactivate the EFI Frambuffer with efifb:off</p></div>
</div>
<div class="sect2">
<h3 id="_binding_gpu_to_vfio_driver_at_boot_time">Binding GPU to VFIO Driver at boot time</h3>
<div class="paragraph"><p>We first gather the PCI Vendor and product IDs from <code>pciutils</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>lspci -nn |grep VGA</code></pre>
</div></div>
<div class="listingblock">
<div class="title">100-sno-vfiopci.bu</div>
<div class="content">
<pre><code>variant: openshift
version: 4.10.0
metadata:
  name: 100-sno-vfiopci
  labels:
    machineconfiguration.openshift.io/role: master
storage:
  files:
  - path: /etc/modprobe.d/vfio.conf
    mode: 0644
    overwrite: true
    contents:
      inline: |
        options vfio-pci ids=10de:2206,10de:1aef
  - path: /etc/modules-load.d/vfio-pci.conf
    mode: 0644
    overwrite: true
    contents:
      inline: vfio-pci</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>dnf install butane
butane 100-sno-vfiopci.bu -o 100-sno-vfiopci.yaml
oc apply -f 100-sno-vfiopci.yaml</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_unbinding_vtconsole_at_boot_time">Unbinding VTConsole at boot time</h3>
<div class="paragraph"><p>Ref: <a href="https://docs.kernel.org/fb/fbcon.html">https://docs.kernel.org/fb/fbcon.html</a></p></div>
<div class="listingblock">
<div class="title">98-sno-vtconsole-unbind.yaml</div>
<div class="content">
<pre><code>apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 98-sno-vtconsole-unbind
spec:
  config:
    ignition:
      version: 3.1.0
    systemd:
      units:
      - contents: |
         [Unit]
         Description=Dettach GPU VT Console
         After=ignition-firstboot-complete.service
         Before=kubelet.service crio.service

         [Service]
         Type=oneshot
         ExecStart=/bin/bash -c "/bin/echo 0 &gt; /sys/class/vtconsole/vtcon0/bind"

         [Install]
         WantedBy=kubelet.service
        enabled: true
        name: dettachvtconsole.service</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_add_gpu_as_hardware_device_of_your_node">Add GPU as Hardware Device of your node</h3>
<div class="paragraph"><p>Ref: <a href="https://github.com/kubevirt/kubevirt/blob/main/docs/devel/host-devices-and-device-plugins.md">https://github.com/kubevirt/kubevirt/blob/main/docs/devel/host-devices-and-device-plugins.md</a></p></div>
<div class="listingblock">
<div class="content">
<pre><code>oc edit hyperconverged kubevirt-hyperconverged -n openshift-cnv</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>apiVersion: hco.kubevirt.io/v1
kind: HyperConverged
metadata:
  name: kubevirt-hyperconverged
  namespace: openshift-cnv
spec:
  permittedHostDevices:
    pciHostDevices:
    - pciDeviceSelector: "10DE:2206"
      resourceName: "nvidia.com/GEFORCE_RTX_3080"
    - pciDeviceSelector: "10DE:1AEF"
      resourceName: "nvidia.com/GEFORCE_RTX_3080_AUDIO"
...</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_passthrough_one_of_the_usb_host_controller_to_the_vm">Passthrough one of the USB Host Controller to the VM</h2>
<div class="sectionbody">
<div class="paragraph"><p>In order to directly connect a mouse, keyboard, audio device etc directly to
the VM we passthrough one if the USB controller directly to the VM.</p></div>
<div class="sect2">
<h3 id="_identify_a_usb_controller_and_its_iommu_group">Identify a USB Controller and its IOMMU group</h3>
<div class="paragraph"><p><a href="https://docs.openshift.com/container-platform/4.8/virt/virtual_machines/advanced_vm_management/virt-configuring-pci-passthrough.html">https://docs.openshift.com/container-platform/4.8/virt/virtual_machines/advanced_vm_management/virt-configuring-pci-passthrough.html</a></p></div>
<div class="paragraph"><p>We first need to indentify it using <code>pciutils</code>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>lspci -nnk</code></pre>
</div></div>
<div class="paragraph"><p>After selecting the USB Controller we want to dedicate to the Virtual Machine we
should verify that this is the only PCI device in its IOMMU group.
We first look for the PCI address in the iommu_groups folder structure, the list
the PCI addresses belonging to this IOMMU group.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>find /sys/kernel/iommu_groups/ -iname "*0b:00.3*"
ls /sys/kernel/iommu_groups/27/devices/</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_add_the_usb_controller_as_hardware_device_of_your_node">Add the USB Controller as Hardware Device of your node</h3>
<div class="paragraph"><p>Ref: <a href="https://access.redhat.com/solutions/6250271">https://access.redhat.com/solutions/6250271</a>
Ref: <a href="https://kubevirt.io/user-guide/virtual_machines/host-devices/#listing-permitted-devices">https://kubevirt.io/user-guide/virtual_machines/host-devices/#listing-permitted-devices</a></p></div>
<div class="paragraph"><p>Once identified we add its Vendor and product IDs to the list of permitted
Host Devices.</p></div>
<div class="paragraph"><p>Currently, Kubevirt does not allow providing a specific PCI address, therefore
the pciDeviceSelector will match all similar USB Host Controller from the node.
However, as we will only bind the one we are interested in to the VFIO-PCI
driver the other ones will not be available for pci passthrough.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>oc edit hyperconverged kubevirt-hyperconverged -n openshift-cnv</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>apiVersion: hco.kubevirt.io/v1
kind: HyperConverged
metadata:
  name: kubevirt-hyperconverged
  namespace: openshift-cnv
:spec:
  permittedHostDevices:
    pciHostDevices:
    - pciDeviceSelector: "1222:164F"
      resourceName: "amd.com/XHCI_USB3_Controller"
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_binding_the_usb_controller_to_vfio_pci_driver_at_boot_time">Binding the USB Controller to VFIO-PCI driver at boot time</h3>
<div class="paragraph"><p>Ref: <a href="https://www.reddit.com/r/VFIO/comments/bjbes0/how_to_force_usb_30_controller_to_bind_to_vfio/">https://www.reddit.com/r/VFIO/comments/bjbes0/how_to_force_usb_30_controller_to_bind_to_vfio/</a></p></div>
<div class="listingblock">
<div class="title">98-sno-xhci-unbind.yaml</div>
<div class="content">
<pre><code>apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 98-sno-xhci-unbind
spec:
  config:
    ignition:
      version: 3.1.0
    systemd:
      units:
      - contents: |
         [Unit]
         Description=Unbind USB Host Controller Driver
         After=ignition-firstboot-complete.service
         Before=kubelet.service crio.service

         [Service]
         Type=oneshot
         ExecStart=/bin/bash -c "/bin/echo 0000:0b:00.3 &gt; /sys/bus/pci/devices/0000\\:0b\\:00.3/driver/unbind"
         ExecStart=/bin/bash -c "/bin/echo vfio-pci &gt; /sys/bus/pci/devices/0000\\:0b\\:00.3/driver_override"
         ExecStart=/bin/bash -c "/bin/echo 1043 87c0 &gt; /sys/bus/pci/drivers/vfio-pci/new_id"

         [Install]
         WantedBy=kubelet.service
        enabled: true
        name: unbindusbcontroller.service</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">double backslash with systemd in pci device id path
<a href="https://www.freedesktop.org/software/systemd/man/systemd.syntax.html">https://www.freedesktop.org/software/systemd/man/systemd.syntax.html</a></td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_virtual_machine">Creating Virtual Machine</h2>
<div class="sectionbody">
<div class="paragraph"><p>The virtual machine will use existing LVM Logical volumes, here we will assume
we already have the Operating System installed on the LV with a UEFI boot.</p></div>
<div class="sect2">
<h3 id="_create_pv_and_pv_claim_out_of_local_lvm_disks">Create PV and PV Claim out of local LVM disks</h3>
<div class="paragraph"><p>Binding PV and PVC by label <a href="https://docs.openshift.com/container-platform/3.3/install_config/storage_examples/binding_pv_by_label.html">https://docs.openshift.com/container-platform/3.3/install_config/storage_examples/binding_pv_by_label.html</a></p></div>
<div class="listingblock">
<div class="title">fedora35.yaml</div>
<div class="content">
<pre><code>---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: fedora35
  labels:
    vol: fedora35
spec:
  capacity:
    storage: 100Gi
  local:
    path: /dev/fedora_da2/fedora35
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  volumeMode: Block
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - da2
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: fedora35
  labels:
    vol: fedora35
spec:
  accessModes:
  - ReadWriteOnce
  volumeMode: Block
  resources:
    requests:
      storage: 100Gi
  storageClassName: local-storage</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_defining_the_virtual_machine">Defining the Virtual Machine</h3>
<div class="paragraph"><p>The virtual machines we will use as Desktops comes with a few specities:
* We will passthrough the entire GPU
  Ref: <a href="https://kubevirt.io/2021/intel-vgpu-kubevirt.html">https://kubevirt.io/2021/intel-vgpu-kubevirt.html</a>
* We will remove the existing default virtual VGA
  ref: <a href="https://kubevirt.io/api-reference/master/definitions.html#_v1_devices">https://kubevirt.io/api-reference/master/definitions.html#_v1_devices</a>
* We will passthrough en entire USB controller
* We will use UEFI boot to be closer from typical BareMetal
  Ref: <a href="https://docs.openshift.com/container-platform/4.10/virt/virtual_machines/advanced_vm_management/virt-efi-mode-for-vms.html">https://docs.openshift.com/container-platform/4.10/virt/virtual_machines/advanced_vm_management/virt-efi-mode-for-vms.html</a></p></div>
<div class="listingblock">
<div class="title">fedora35.yaml</div>
<div class="content">
<pre><code>apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: fedora35
  namespace: epheo
spec:
  running: true
  template:
    metadata:
      labels:
        kubevirt.io/domain: fedora35
    spec:
      domain:
        cpu:
          cores: 8
          sockets: 2
          threads: 1
        features:
          acpi: {}
          smm:
            enabled: true
        firmware:
          bootloader:
            efi:
              secureBoot: true
        devices:
          disks:
            - bootOrder: 1
              disk:
                bus: virtio
              name: pvdisk
            - disk:
                bus: virtio
              name: cloudinitdisk
          autoattachGraphicsDevice: false
          gpus:
            - deviceName: nvidia.com/GEFORCE_RTX_3080
              name: gpuvideo
          hostDevices:
            - deviceName: devices.kubevirt.io/USB3_Controller
              name: usbcontroller
          interfaces:
            - masquerade: {}
              name: default
          networkInterfaceMultiqueue: true
          rng: {}
        resources:
          requests:
            memory: 32G
      hostname: fedora35
      networks:
        - name: default
          pod: {}
      terminationGracePeriodSeconds: 0
      volumes:
        - persistentVolumeClaim:
            claimName: 'fedora35'
          name: pvdisk
        - cloudInitNoCloud:
            userData: |-
              #cloud-config
              password: fedora
              chpasswd: { expire: False }
          name: cloudinitdisk</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next">Next</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter is used as reference to the furture improvements to make.</p></div>
<div class="sect2">
<h3 id="_network_interfaces">Network Interfaces</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://docs.openshift.com/container-platform/4.2/cnv/cnv_users_guide/cnv-attaching-vm-multiple-networks.html">https://docs.openshift.com/container-platform/4.2/cnv/cnv_users_guide/cnv-attaching-vm-multiple-networks.html</a>
</p>
</li>
<li>
<p>
<a href="https://docs.openshift.com/container-platform/4.10/virt/node_network/virt-troubleshooting-node-network.html">https://docs.openshift.com/container-platform/4.10/virt/node_network/virt-troubleshooting-node-network.html</a>
</p>
</li>
<li>
<p>
<a href="https://docs.openshift.com/container-platform/4.10/networking/multiple_networks/configuring-additional-network.html#nw-multus-bridge-object_configuring-additional-network">https://docs.openshift.com/container-platform/4.10/networking/multiple_networks/configuring-additional-network.html#nw-multus-bridge-object_configuring-additional-network</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_enabling_dedicated_resources_for_virtual_machines">Enabling dedicated resources for virtual machines</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://docs.openshift.com/container-platform/4.10/virt/virtual_machines/advanced_vm_management/virt-dedicated-resources-vm.html">https://docs.openshift.com/container-platform/4.10/virt/virtual_machines/advanced_vm_management/virt-dedicated-resources-vm.html</a>
</p>
</li>
<li>
<p>
<a href="https://docs.openshift.com/container-platform/4.10/virt/virtual_machines/advanced_vm_management/virt-using-huge-pages-with-vms.html">https://docs.openshift.com/container-platform/4.10/virt/virtual_machines/advanced_vm_management/virt-using-huge-pages-with-vms.html</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_using_microshift_and_rhel_for_edge">Using MicroShift and RHEL for Edge</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://microshift.io/">https://microshift.io/</a>
</p>
</li>
<li>
<p>
<a href="https://next.redhat.com/2022/01/19/introducing-microshift/">https://next.redhat.com/2022/01/19/introducing-microshift/</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/redhat-et/microshift">https://github.com/redhat-et/microshift</a>
</p>
</li>
<li>
<p>
<a href="https://community.ibm.com/community/user/cloud/blogs/alexei-karve/2022/03/07/microshift-11">https://community.ibm.com/community/user/cloud/blogs/alexei-karve/2022/03/07/microshift-11</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2022-04-24 12:04:19 CEST
</div>
</div>
</body>
</html>
